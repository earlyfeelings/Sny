@page "/goals"
@using Sny.Api.Dtos.Models.Goals
@using Sny.Web.Components;
@using Services.BackendProvider
@using Sny.Web.Model
@inject HttpClient Http
@inject IBackendProvider _backendProvider
@inject NavigationManager _navManager

<Header Title="Cíle" Buttons="HeaderButtons()"></Header>

<div id="goals">
    @if(_goals is null)
    {
        <Loading></Loading>
    }
    else
    {
        foreach (var goal in _goals.OrderByDescending(d => d.Active))
        {
            <GoalPreview Goal="goal"></GoalPreview>
        }
    }
</div>

@if (_goals is not null)
{
    <Footer Buttons="FooterButtons()"></Footer>
}

@code
{
    private IEnumerable<GoalDto>? _goals;

    protected override async Task OnInitializedAsync()
    {
        _goals = await Http.GetFromJsonAsync<GoalDto[]>(_backendProvider.GetUri("goals"));
    }

    private IEnumerable<HeaderButton> HeaderButtons() 
    {
        yield return new HeaderButton("Přidat cíl", async () => await AddNewGoal());
    }

    private async Task AddNewGoal() {
        AddRequestGoalDto addGoal = new AddRequestGoalDto("Nový cíl", false, "Popisek cíle. Můžete napsat třeba svojí motivaci, proč stojíte o dosíhnutí vybraného cíle.");
        var response = await Http.PostAsJsonAsync<AddRequestGoalDto>(_backendProvider.GetUri("goals"), addGoal);
        var responseObject = await response.Content.ReadFromJsonAsync<AddResponseGoalDto>();
        if (responseObject == null) throw new ApplicationException("Response is null");

        _navManager.NavigateTo($"goals/{responseObject.Id}");
    }

    private IEnumerable<HeaderButton> FooterButtons()
    {
        yield return new HeaderButton("Zpět na Dashboard", () => _navManager.NavigateTo("/"));
    }
}